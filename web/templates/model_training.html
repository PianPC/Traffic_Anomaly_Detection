{% extends "base.html" %}

{% block content %}
<div class="card mt-4">
    <div class="card-header">
        <h4>模型训练</h4>
    </div>
    <div class="card-body">
        <!-- 数据集上传区域 -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">数据集上传</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="datasetName" class="form-label">数据集名称</label>
                                <input type="text" class="form-control" id="datasetName" name="datasetName" required>
                            </div>
                            <div class="mb-3">
                                <label for="files" class="form-label">选择文件</label>
                                <input type="file" class="form-control" id="files" name="files[]" multiple required>
                            </div>
                            <button type="submit" class="btn btn-primary">上传</button>
                        </form>

                        <!-- 上传进度条 -->
                        <div class="mt-3" id="uploadProgress" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted">上传进度: <span id="uploadPercent">0%</span></small>
                        </div>

                        <!-- 处理状态显示 -->
                        <div class="mt-3" id="processingStatus" style="display: none;">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border text-primary me-2" role="status" id="processingSpinner">
                                    <span class="visually-hidden">处理中...</span>
                                </div>
                                <div class="text-primary" id="processingText">正在处理文件...</div>
                                <div class="ms-2" id="processingIcon" style="display: none;">
                                    <i class="fas fa-check-circle text-success"></i>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted" id="processingDetail">正在转换文件格式...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">训练设置</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">选择数据集</label>
                            <select class="form-select" id="datasetSelect">
                                <option value="">请选择数据集</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">选择模型</label>
                            <select class="form-select" id="modelSelect">
                                <option value="">请选择模型</option>
                            </select>
                        </div>
                        <button class="btn btn-primary w-100" id="startTrainingBtn">开始训练</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 训练进度和结果 -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">训练进度</div>
                    <div class="card-body">
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar" id="trainingProgress" role="progressbar" style="width: 0%">0%</div>
                        </div>
                        <div id="trainingStatus">等待开始训练...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">训练指标</div>
                    <div class="card-body">
                        <div id="metricsChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 模型评估结果 -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">混淆矩阵</div>
                    <div class="card-body">
                        <div id="confusionMatrix" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">ROC曲线</div>
                    <div class="card-body">
                        <div id="rocCurve" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 初始化图表
let metricsChart = echarts.init(document.getElementById('metricsChart'));
let confusionMatrix = echarts.init(document.getElementById('confusionMatrix'));
let rocCurve = echarts.init(document.getElementById('rocCurve'));

// 训练指标图表配置
let metricsOption = {
    title: {
        text: '训练指标'
    },
    tooltip: {
        trigger: 'axis'
    },
    legend: {
        data: ['训练损失', '验证损失', '训练准确率', '验证准确率']
    },
    xAxis: {
        type: 'category',
        data: []
    },
    yAxis: [
        {
            type: 'value',
            name: '损失',
            position: 'left'
        },
        {
            type: 'value',
            name: '准确率',
            position: 'right',
            axisLabel: {
                formatter: '{value}%'
            }
        }
    ],
    series: [
        {
            name: '训练损失',
            type: 'line',
            data: []
        },
        {
            name: '验证损失',
            type: 'line',
            data: []
        },
        {
            name: '训练准确率',
            type: 'line',
            yAxisIndex: 1,
            data: []
        },
        {
            name: '验证准确率',
            type: 'line',
            yAxisIndex: 1,
            data: []
        }
    ]
};

// 混淆矩阵图表配置
let confusionMatrixOption = {
    title: {
        text: '混淆矩阵'
    },
    tooltip: {
        position: 'top'
    },
    grid: {
        height: '70%',
        top: '15%'
    },
    xAxis: {
        type: 'category',
        data: ['预测正常', '预测异常'],
        splitArea: {
            show: true
        }
    },
    yAxis: {
        type: 'category',
        data: ['实际正常', '实际异常'],
        splitArea: {
            show: true
        }
    },
    visualMap: {
        min: 0,
        max: 1,
        calculable: true,
        orient: 'horizontal',
        left: 'center',
        bottom: '15%'
    },
    series: [{
        name: '混淆矩阵',
        type: 'heatmap',
        data: [],
        label: {
            show: true
        },
        emphasis: {
            itemStyle: {
                shadowBlur: 10,
                shadowColor: 'rgba(0, 0, 0, 0.5)'
            }
        }
    }]
};

// ROC曲线图表配置
let rocOption = {
    title: {
        text: 'ROC曲线'
    },
    tooltip: {
        trigger: 'axis'
    },
    xAxis: {
        type: 'value',
        name: '假阳性率',
        min: 0,
        max: 1
    },
    yAxis: {
        type: 'value',
        name: '真阳性率',
        min: 0,
        max: 1
    },
    series: [{
        name: 'ROC曲线',
        type: 'line',
        data: [],
        smooth: true,
        markLine: {
            data: [[{
                coord: [0, 0]
            }, {
                coord: [1, 1]
            }]],
            lineStyle: {
                type: 'dashed'
            }
        }
    }]
};

// 初始化图表
metricsChart.setOption(metricsOption);
confusionMatrix.setOption(confusionMatrixOption);
rocCurve.setOption(rocOption);

// 检查处理状态
function checkProcessingStatus() {
    fetch('/check_processing_status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'processing') {
                // 显示处理中状态
                document.getElementById('processingSpinner').style.display = 'block';
                document.getElementById('processingIcon').style.display = 'none';
                document.getElementById('processingText').textContent = '正在处理文件...';
                document.getElementById('processingDetail').textContent = '正在转换文件格式...';
                setTimeout(checkProcessingStatus, 1000);
            } else if (data.status === 'completed') {
                // 显示处理完成状态
                document.getElementById('processingSpinner').style.display = 'none';
                document.getElementById('processingIcon').style.display = 'block';
                document.getElementById('processingText').textContent = '处理完成';
                document.getElementById('processingDetail').textContent = '文件已成功转换为JSON格式';
                loadDatasets(); // 刷新数据集列表
            }
        })
        .catch(error => {
            console.error('检查处理状态时出错:', error);
            // 发生错误时显示错误状态
            document.getElementById('processingSpinner').style.display = 'none';
            document.getElementById('processingIcon').style.display = 'block';
            document.getElementById('processingIcon').innerHTML = '<i class="fas fa-times-circle text-danger"></i>';
            document.getElementById('processingText').textContent = '处理失败';
            document.getElementById('processingDetail').textContent = '文件处理过程中发生错误';
        });
}

// 修改文件上传处理函数
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const xhr = new XMLHttpRequest();

    // 重置状态显示
    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('processingStatus').style.display = 'none';
    document.getElementById('processingSpinner').style.display = 'none';
    document.getElementById('processingIcon').style.display = 'none';

    xhr.upload.addEventListener('progress', function(e) {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            document.querySelector('.progress-bar').style.width = percent + '%';
            document.getElementById('uploadPercent').textContent = percent + '%';
        }
    });

    xhr.onload = function() {
        if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            if (response.status === 'success') {
                // 隐藏上传进度条，显示处理状态
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('processingStatus').style.display = 'block';
                document.getElementById('processingSpinner').style.display = 'block';
                document.getElementById('processingIcon').style.display = 'none';

                // 开始检查处理状态
                checkProcessingStatus();
            } else {
                // 显示错误状态
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('processingStatus').style.display = 'block';
                document.getElementById('processingSpinner').style.display = 'none';
                document.getElementById('processingIcon').style.display = 'block';
                document.getElementById('processingIcon').innerHTML = '<i class="fas fa-times-circle text-danger"></i>';
                document.getElementById('processingText').textContent = '上传失败';
                document.getElementById('processingDetail').textContent = response.message;
            }
        } else {
            // 显示错误状态
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('processingStatus').style.display = 'block';
            document.getElementById('processingSpinner').style.display = 'none';
            document.getElementById('processingIcon').style.display = 'block';
            document.getElementById('processingIcon').innerHTML = '<i class="fas fa-times-circle text-danger"></i>';
            document.getElementById('processingText').textContent = '上传失败';
            document.getElementById('processingDetail').textContent = '请重试';
        }
    };

    xhr.open('POST', '/upload_training_dataset', true);
    xhr.send(formData);
});

// 加载数据集列表
function loadDatasets() {
    fetch('/get_datasets')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const select = document.getElementById('datasetSelect');
                select.innerHTML = '<option value="">请选择数据集</option>';
                data.train_datasets.forEach(dataset => {
                    const option = document.createElement('option');
                    option.value = dataset.name;
                    option.textContent = dataset.name;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => console.error('加载数据集失败:', error));
}

// 加载模型列表
function loadModels() {
    fetch('/get_available_models')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const select = document.getElementById('modelSelect');
                select.innerHTML = '<option value="">请选择模型</option>';
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = `${model.name} (${model.type})`;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => console.error('加载模型列表失败:', error));
}

// 开始训练
document.getElementById('startTrainingBtn').addEventListener('click', function() {
    const dataset = document.getElementById('datasetSelect').value;
    const model = document.getElementById('modelSelect').value;

    if (!dataset) {
        alert('请选择数据集');
        return;
    }
    if (!model) {
        alert('请选择模型');
        return;
    }

    // 发送训练请求
    fetch('/train_model', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            dataset: dataset,
            model: model
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // 开始监听训练进度
            startTrainingProgress();
        } else {
            alert('开始训练失败: ' + data.message);
        }
    })
    .catch(error => console.error('开始训练失败:', error));
});

// 监听训练进度
function startTrainingProgress() {
    const progressBar = document.getElementById('trainingProgress');
    const statusDiv = document.getElementById('trainingStatus');
    let eventSource = new EventSource('/training_progress');

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.status === 'progress') {
            // 更新进度条
            progressBar.style.width = data.progress + '%';
            progressBar.textContent = data.progress + '%';
            statusDiv.textContent = data.message;

            // 更新训练指标图表
            if (data.metrics) {
                updateMetricsChart(data.metrics);
            }
        } else if (data.status === 'completed') {
            // 训练完成，更新评估结果
            eventSource.close();
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            statusDiv.textContent = '训练完成';

            // 更新评估结果图表
            if (data.evaluation) {
                updateEvaluationCharts(data.evaluation);
            }
        } else if (data.status === 'error') {
            eventSource.close();
            statusDiv.textContent = '训练失败: ' + data.message;
        }
    };

    eventSource.onerror = function() {
        eventSource.close();
        statusDiv.textContent = '训练进度监听失败';
    };
}

// 更新训练指标图表
function updateMetricsChart(metrics) {
    metricsOption.xAxis.data = metrics.epochs;
    metricsOption.series[0].data = metrics.train_loss;
    metricsOption.series[1].data = metrics.val_loss;
    metricsOption.series[2].data = metrics.train_accuracy;
    metricsOption.series[3].data = metrics.val_accuracy;
    metricsChart.setOption(metricsOption);
}

// 更新评估结果图表
function updateEvaluationCharts(evaluation) {
    // 更新混淆矩阵
    confusionMatrixOption.series[0].data = evaluation.confusion_matrix.map((row, i) =>
        row.map((value, j) => [j, i, value])
    ).flat();
    confusionMatrix.setOption(confusionMatrixOption);

    // 更新ROC曲线
    rocOption.series[0].data = evaluation.roc_curve;
    rocCurve.setOption(rocOption);
}

// 初始化页面
document.addEventListener('DOMContentLoaded', function() {
    loadDatasets();
    loadModels();
    initCharts();
});

// 窗口大小改变时重绘图表
window.addEventListener('resize', function() {
    metricsChart.resize();
    confusionMatrix.resize();
    rocCurve.resize();
});
</script>
{% endblock %}

